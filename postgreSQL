-- Users table
CREATE TABLE users (
  id BIGSERIAL PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  username TEXT UNIQUE,
  password_hash TEXT NOT NULL,        -- e.g. Argon2/bcrypt output
  password_algo TEXT NOT NULL,        -- "argon2id" or "bcrypt" (for future migration)
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_login_at TIMESTAMPTZ,
  failed_login_attempts INT NOT NULL DEFAULT 0,
  locked_until TIMESTAMPTZ,           -- null if not locked
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  mfa_enabled BOOLEAN NOT NULL DEFAULT FALSE,
  mfa_secret TEXT,                    -- encrypted at rest
  password_reset_token_hash TEXT,     -- store hash of reset token
  password_reset_expires_at TIMESTAMPTZ,
  -- optionally store password history hashes for reuse prevention
  CONSTRAINT email_nonempty CHECK (length(email) > 0)
);

CREATE INDEX idx_users_email ON users (email);
CREATE TABLE auth_audit (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id),
  event_type TEXT NOT NULL, -- e.g. 'login_success','login_fail','reset_requested'
  ip_addr INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  details JSONB
);
CREATE TABLE password_history (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  password_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX ph_user_idx ON password_history (user_id);
-- app computes `password_hash` using Argon2/bcrypt before calling DB
INSERT INTO users (email, username, password_hash, password_algo)
VALUES ($1, $2, $3, $4) -- placeholders for DB client/ORM API
RETURNING id, created_at;
SELECT id, password_hash, password_algo, failed_login_attempts, locked_until, is_active
FROM users
WHERE email = $1;
-- increment
UPDATE users
SET failed_login_attempts = failed_login_attempts + 1,
    updated_at = now()
WHERE id = $1
RETURNING failed_login_attempts;

-- if returned failed_login_attempts >= threshold, set lock:
UPDATE users
SET locked_until = now() + INTERVAL '15 minutes', -- example
    updated_at = now()
WHERE id = $1;
UPDATE users
SET password_reset_token_hash = $1,
    password_reset_expires_at = now() + INTERVAL '1 hour',
    updated_at = now()
WHERE email = $2
RETURNING id, email;
-- app computes token_hash from the token user supplied
WITH matched AS (
  SELECT id FROM users
  WHERE password_reset_token_hash = $1
    AND password_reset_expires_at > now()
)
UPDATE users
SET password_hash = $2,
    password_algo = $3,
    password_reset_token_hash = NULL,
    password_reset_expires_at = NULL,
    updated_at = now()
WHERE id IN (SELECT id FROM matched)
RETURNING id;
INSERT INTO auth_audit (user_id, event_type, ip_addr, user_agent, details)
VALUES ($1, $2, $3, $4, $5);
